@model CardCollection

@{
    int count = 0;
}

<button id="add-file-btn" type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#myModal">Add File</button>

<button id="create-card-btn" type="button" class="btn btn-success">Create Card</button>


<div id="file-nav">

    @foreach (var file in Model.CardFiles)
    {
        var tabClass = "";
        switch (count % 3)
        {
            case 0:
                tabClass = "tab-one";
                break;
            case 1:
                tabClass = "tab-two";
                break;
            case 2:
                tabClass = "tab-three";
                break;
        }
        count++;
        <div class="file-tab @tabClass" data-file-id="@file.Id">
            <div class="tab-text" title="@file.Label">@file.Label</div>
        </div>
    }

</div>

<div id="carousel-container">
    
</div>



<!-- The Modal -->
<div class="modal fade bg-dark text-light" id="myModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Create a new file</h5>
                <button type="button" class="btn-close text-light" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="create-file-form" action="@Url.Action("CreateFile", "CardCollection")" method="post">
                    <div class="form-group">
                        <label for="file-name" class="col-form-label">Name your file:</label>
                        <input type="text" class="form-control bg-dark text-light" id="file-name" name="name">
                    </div>
                    <input type="hidden" name="parentCollectionId" value="@Model.Id" />
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary text-light" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary text-light" form="create-file-form">Create</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $("#create-file-form").submit(function (event) {
                event.preventDefault(); // prevent form from submitting the traditional way

                $.ajax({
                    type: "POST",
                    url: "@Url.Action("CreateFile", "CardCollection")",
                    data: $(this).serialize(),
                    success: function () {
                        // Refresh the current page
                        location.reload();
                    },
                    error: function (error) {
                        console.error("An error occurred:", error);
                        // Handle error - maybe display a message to the user
                    }
                });
            });

            $(".file-tab").click(function () {
                // Remove the active class from any other tabs
                $(".file-tab").removeClass("active-file-tab");

                // Add the active class to the clicked tab
                $(this).addClass("active-file-tab");

                // Fetch and display the index cards for the selected file
                var fileId = $(this).data("file-id");
                // loadIndexCards(fileId);
            });

            $('.file-tab').click(function () {
                const fileId = $(this).data('file-id'); //getFileId
                // Load cards from active file
                loadCards(fileId);
            });

            $("#create-card-btn").click(function () {
                // Check if there's an active file tab
                var activeTab = $(".file-tab.active-file-tab");
                if (activeTab.length === 0) {
                    alert("Please select a file first.");
                    return;
                }

                var blankCardHtml = `
                            <div class="carousel-item">
                                <div class="index-card">
                                    <input type="text" class="card-title" placeholder="Card Title">
                                    <img src="/images/close.png" class="close-button" alt="close">
                                    <img src="/images/save.png" class="save-button" alt="save">
                                    <textarea class="card-body" placeholder="Card Body"></textarea>
                                </div>
                            </div>`;

                $('#carousel .carousel-inner').append(blankCardHtml);
                $('#carousel .carousel-item.active').removeClass('active');
                $('#carousel .carousel-item:last').addClass('active');

            });

            $(document).on('click', '.save-button', function () {
                var cardElement = $(this).closest('.index-card');
                var cardTitle = cardElement.find('.card-title').val();
                var cardBody = cardElement.find('.card-body').val();


                // Retrieve the file ID from the active tab
                var activeTab = $(".file-tab.active-file-tab");
                if (activeTab.length === 0) {
                    alert("Please select a file first.");
                    return;
                }
                var fileId = activeTab.data("file-id");

                // Now, you can call the function to save this card's data to the active file.
                createCardInFile(cardTitle, cardBody, fileId);
            });
        });

        function createCardInFile(cardTitle, cardBody, fileId) {
            $.ajax({
                type: "POST",
                url: "@Url.Action("CreateCard", "CardCollection")",
                data: {
                    title: cardTitle,
                    body: cardBody,
                    fileId: fileId
                }, // pass card information to server
                success: function (data) {
                    loadCards(fileId)
                    alert("Card successfully created!");
                },
                error: function (xhr, status, error) {
                    console.error("Error creating card:", xhr.responseText);
                }
            });
        }

        function loadCards(fileId) {
            $.ajax({
                type: "GET",
                url: "/CardCollection/GetFilePartial",
                data: { fileId: fileId }, // pass fileId to server
                success: function (data) {
                    $('#carousel-container').html(data); // inserts card partial into carousel container
                },
                error: function () {
                    alert('An error occurred while loading the cards. Please try again.');
                }
            });
        }

    </script>
}